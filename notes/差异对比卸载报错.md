# Monaco DiffEditor "TextModel got disposed before DiffEditorWidget model got reset" 错误修复

## 问题描述
当AI调用文件工具（如write_file、apply_diff等）时，前端会弹出差异对比标签页。用户点击"确定"后，差异对比标签页关闭，控制台出现以下错误：

```
Uncaught Error: TextModel got disposed before DiffEditorWidget model got reset
Error: TextModel got disposed before DiffEditorWidget model got reset
    at ER.value (http://127.0.0.1:8000/static/monaco/vs/editor.api-CalNCsUg.js:390:50593)
    at A._deliver (http://127.0.0.1:8000/static/monaco/vs/editor.api-CalNCsUg.js:7:2719)
    at A._deliverQueue (http://127.0.0.1:8000/static/monaco/vs/editor.api-CalNCsUg.js:7:2810)
    at A.fire (http://127.0.0.1:8000/static/monaco/vs/editor.api-CalNCsUg.js:7:3146)
    at sl.dispose (http://127.0.0.1:8000/static/monaco/vs/editor.api-CalNCsUg.js:244:68898)
```

## 错误原因分析

### 1. 技术原因
这是 Monaco Editor 0.51+ 版本与 `@monaco-editor/react` 组件库的兼容性问题。当 `DiffEditor` 组件卸载时，Monaco 内部清理时序出现问题：
- TextModel 在 DiffEditorWidget 重置之前就被释放
- 导致内部事件触发顺序错误

### 2. 相关 GitHub Issue
- 原始问题：https://github.com/suren-atoyan/monaco-react/issues/647
- Monaco 内部修复：microsoft/vscode#218001
- 影响版本：Monaco 0.51.0 及以上

## 修复方案

### 方案1：添加特定属性
在 `frontend/src/components/editor/editor/CoreEditor.tsx` 中的 `DiffEditor` 组件添加：
```tsx
<DiffEditor
  // ... 其他属性
  keepCurrentOriginalModel={true}
  keepCurrentModifiedModel={true}
  // ... 其他属性
/>
```

### 方案2：降级 Monaco 版本
```json
// package.json 中强制使用 Monaco 0.50.0
"overrides": {
  "monaco-editor": "0.50.0"
}
```

### 方案3：手动管理 TextModel（让ai写了点，没卵用，不打算深究）
```typescript
// 在组件卸载时手动清理
useEffect(() => {
  return () => {
    if (monacoRef.current) {
      const models = monacoRef.current.editor.getModels();
      models.forEach(model => {
        if (!model.isDisposed()) {
          model.dispose();
        }
      });
    }
  };
}, []);
```

### 方案4：直接放掉不管，反正不影响功能（√）
当前忽略报错，以后看到影响再说。